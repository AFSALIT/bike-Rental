
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bike Manager - Multi Rental Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --primary-dark: #2980b9;
            --secondary: #2c3e50;
            --secondary-light: #3c546c;
            --success: #2ecc71;
            --danger: #e74c3c;
            --light-bg: #f8f9fa;
            --card-shadow: 0 4px 12px rgba(0,0,0,.08);
        }
        
        body {
            background: var(--light-bg);
            padding-bottom: 2rem;
        }
        
        .navbar {
            background: var(--secondary);
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        
        .navbar-brand {
            font-weight: 600;
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 1rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 14px rgba(0,0,0,.12);
        }
        
        .card-header {
            background: white;
            border-bottom: 1px solid rgba(0,0,0,.05);
            font-weight: 600;
            padding: 1rem 1.25rem;
        }
        
        .status-badge {
            padding: .25rem .6rem;
            border-radius: 1rem;
            font-size: .8rem;
            font-weight: 500;
        }
        
        .status-Booked { background: var(--primary); color: #fff; }
        .status-Active { background: var(--primary-dark); color: #fff; }
        .status-Returned { background: var(--success); color: #fff; }
        .status-Cancelled { background: var(--danger); color: #fff; }
        
        .table thead th {
            background: #eef6fd;
            font-weight: 600;
            font-size: 0.85rem;
            padding: 0.75rem;
        }
        
        .table td {
            padding: 0.75rem;
            vertical-align: middle;
        }
        
        .btn {
            border-radius: 6px;
            font-weight: 500;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
        
        .summary-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--secondary);
        }
        
        .summary-card .label {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        /* Mobile-specific styles */
        @media (max-width: 768px) {
            .container {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }
            
            .card {
                border-radius: 10px;
            }
            
            .card-body {
                padding: 1rem;
            }
            
            .table-responsive {
                border-radius: 8px;
                overflow: hidden;
                border: 1px solid #dee2e6;
            }
            
            .table thead {
                display: none;
            }
            
            .table, .table tbody, .table tr, .table td {
                display: block;
                width: 100%;
            }
            
            .table tr {
                margin-bottom: 1rem;
                border-bottom: 1px solid #dee2e6;
                padding: 0.75rem;
                background: white;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,.05);
            }
            
            .table td {
                text-align: right;
                padding: 0.5rem;
                position: relative;
                padding-left: 50%;
                border: none;
            }
            
            .table td:before {
                content: attr(data-label);
                position: absolute;
                left: 0.5rem;
                width: 45%;
                padding-right: 0.5rem;
                text-align: left;
                font-weight: 600;
                color: var(--secondary);
                font-size: 0.8rem;
            }
            
            .table .actions-cell {
                display: flex;
                justify-content: flex-end;
                gap: 0.5rem;
                margin-top: 0.5rem;
            }
            
            .table .actions-cell:before {
                display: none;
            }
            
            .modal-dialog {
                margin: 0.5rem;
            }
            
            .modal-content {
                border-radius: 12px;
            }
            
            .navbar-collapse {
                background: var(--secondary-light);
                padding: 1rem;
                border-radius: 0 0 8px 8px;
                margin-top: 0.5rem;
            }
            
            .summary-card .value {
                font-size: 1.25rem;
            }
            
            .btn-group-mobile {
                display: flex;
                gap: 0.5rem;
                margin-top: 1rem;
            }
            
            .btn-group-mobile .btn {
                flex: 1;
            }
        }
        
        /* Improved form styles */
        .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--secondary);
        }
        
        .form-control, .form-select {
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
        }
        
        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            border-color: var(--primary);
        }
        
        /* Animation for better UX */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease forwards;
        }
        
        /* Toast notification */
        .toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 1055;
        }
        
        .toast {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,.15);
            border-left: 4px solid var(--primary);
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <a class="navbar-brand" href="#"><i class="fa fa-bicycle me-2"></i>Bike Manager</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-controls="nav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="nav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link active" href="/dashboard"><i class="fa fa-layer-group me-1"></i>Multi-Rental Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="/purchase-bike"><i class="fa fa-shopping-cart me-1"></i>Purchase Bike</a></li>
                <li class="nav-item"><a class="nav-link" href="/expense"><i class="fa fa-money-bill-wave me-1"></i>Expenses</a></li>
                <li class="nav-item"><button class="btn btn-outline-light btn-sm ms-2" onclick="downloadReport()"><i class="fa fa-file-excel me-1"></i>Download Excel Report</button></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="row g-3">
        <div class="col-lg-4">
            <div class="card fade-in">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Bikes</h5>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addBikeModal">
                            <i class="fa fa-plus me-1"></i>Add Bike
                        </button>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Search Bikes</label>
                        <div class="input-group">
                            <input type="text" id="bikeSearch" class="form-control" placeholder="Search by bike number/name or last 4 digits for auto-load rentals">
                            <button class="btn btn-outline-secondary" id="searchBikeBtn"><i class="fa fa-search"></i></button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Select Bike</label>
                        <select id="bikeSelect" class="form-select">
                            <option value="" selected disabled>Choose a bike...</option>
                        </select>
                    </div>
                    <div id="selectedBikeInfo" class="small text-muted p-2 bg-light rounded"></div>
                </div>
            </div>
            <div class="card mt-3 fade-in">
                <div class="card-body">
                    <h6 class="mb-3">Summary</h6>
                    <div class="row text-center">
                        <div class="col-3">
                            <div class="value text-primary" id="summaryTotal">0</div>
                            <div class="label">Rentals</div>
                        </div>
                        <div class="col-3">
                            <div class="value text-success" id="summaryActive">0</div>
                            <div class="label">Active</div>
                        </div>
                        <div class="col-3">
                            <div class="value text-info" id="summaryRevenue">₹0</div>
                            <div class="label">Revenue</div>
                        </div>
                        <div class="col-3">
                            <div class="value text-warning" id="summaryCommission">₹0</div>
                            <div class="label">Commission</div>
                        </div>
                    </div>
                    <hr>
                    <h6 class="mb-2">Commission Breakdown</h6>
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="value text-info" id="summaryPlatformFee" style="font-size: 1rem;">₹0</div>
                            <div class="label" style="font-size: 0.7rem;">Platform Fee</div>
                        </div>
                        <div class="col-4">
                            <div class="value text-success" id="summaryServiceCharge" style="font-size: 1rem;">₹0</div>
                            <div class="label" style="font-size: 0.7rem;">Service Charge</div>
                        </div>
                        <div class="col-4">
                            <div class="value text-warning" id="summaryOtherFees" style="font-size: 1rem;">₹0</div>
                            <div class="label" style="font-size: 0.7rem;">Other Fees</div>
                        </div>
                    </div>
                    <hr>
                    <h6 class="mb-2">Available Bikes</h6>
                    <div id="availableBikesEmpty" class="text-muted small">Loading...</div>
                    <ul id="availableBikesList" class="list-group list-group-flush"></ul>
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="card fade-in">
                <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-column flex-md-row">
                    <h5 class="mb-2 mb-md-0">Rentals for Selected Bike</h5>
                    <div class="btn-group-mobile d-md-block">
                        <button id="addRentalBtn" class="btn btn-success btn-sm" disabled data-bs-toggle="modal" data-bs-target="#addRentalModal">
                            <i class="fa fa-plus me-1"></i>Add Rental
                        </button>
                    </div>
                </div>
                <div id="bikeIndividualSummary" class="d-none mb-3 p-3 bg-light rounded">
                    <h6 class="mb-2">Bike Summary</h6>
                    <div class="row text-center">
                        <div class="col-6 mb-2">
                            <small class="text-muted">Total Rentals</small>
                            <div id="bikeTotalRentals" class="h6">0</div>
                        </div>
                        <div class="col-6 mb-2">
                            <small class="text-muted">Total Revenue</small>
                            <div id="bikeTotalRevenue" class="h6">₹0</div>
                        </div>
                        <div class="col-6 mb-2">
                            <small class="text-muted">Total Advance</small>
                            <div id="bikeTotalAdvance" class="h6">₹0</div>
                        </div>
                        <div class="col-6 mb-2">
                            <small class="text-muted">Net Profit</small>
                            <div id="bikeNetProfit" class="h6">₹0</div>
                        </div>
                    </div>
                    <div class="row text-center">
                        <div class="col-6 mb-2">
                            <small class="text-muted">Purchase Price</small>
                            <div id="bikePurchasePrice" class="h6">₹0</div>
                        </div>
                        <div class="col-6 mb-2">
                            <small class="text-muted">Total Expenses</small>
                            <div id="bikeTotalExpenses" class="h6">₹0</div>
                        </div>
                    </div>
                    <div class="row text-center small">
                        <div class="col-3">
                            <small class="text-muted">Active</small>
                            <div id="bikeStatusActive" class="text-success">0</div>
                        </div>
                        <div class="col-3">
                            <small class="text-muted">Booked</small>
                            <div id="bikeStatusBooked" class="text-primary">0</div>
                        </div>
                        <div class="col-3">
                            <small class="text-muted">Returned</small>
                            <div id="bikeStatusReturned" class="text-success">0</div>
                        </div>
                        <div class="col-3">
                            <small class="text-muted">Cancelled</small>
                            <div id="bikeStatusCancelled" class="text-danger">0</div>
                        </div>
                    </div>
                    <button class="btn btn-outline-primary btn-sm mt-2" id="downloadBikeReportBtn">
                        <i class="fa fa-download me-1"></i>Download Report
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm align-middle" id="rentalsTable">
                        <thead>
                            <tr>
                                <th>Period</th>
                                <th>Renter</th>
                                <th>Contact</th>
                                <th>Advance</th>
                                <th>Full Cost</th>
                                <th>Commission</th>
                                <th>Status</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="8" class="text-center text-muted py-4">Select a bike to view rentals</td></tr>
                        </tbody>
                    </table>
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Charts Section -->
    <div class="row mt-4" id="dashboardCharts" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="mb-4">Analytics Dashboard</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Revenue Trends</h6>
                                    <canvas id="revenueChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Rental Status Distribution</h6>
                                    <canvas id="statusChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Expense Breakdown</h6>
                                    <canvas id="expenseChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Commission Breakdown</h6>
                                    <canvas id="commissionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container"></div>

<!-- Add Bike Modal -->
<div class="modal fade" id="addBikeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Bike</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addBikeForm">
          <div class="mb-3">
            <label class="form-label">Bike Number *</label>
            <input type="text" class="form-control" id="newBikeNumber" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Bike Name *</label>
            <input type="text" class="form-control" id="newBikeName" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="submitAddBike">Add Bike</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Rental Modal -->
<div class="modal fade" id="addRentalModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Rental</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addRentalForm">
          <div class="row g-2">
            <div class="col-12 col-md-6">
              <label class="form-label">Start Date *</label>
              <input type="text" class="form-control" id="rentStart" placeholder="DD/MM/YYYY" pattern="\d{1,2}/\d{1,2}/\d{4}" title="Please enter date in DD/MM/YYYY format" required>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">End Date *</label>
              <input type="text" class="form-control" id="rentEnd" placeholder="DD/MM/YYYY" pattern="\d{1,2}/\d{1,2}/\d{4}" title="Please enter date in DD/MM/YYYY format" required>
            </div>
          </div>
          <div class="row g-2 mt-1">
            <div class="col-6 col-md-4">
              <label class="form-label">Advance</label>
              <input type="number" class="form-control" id="rentAdvance" value="0" min="0">
            </div>
            <div class="col-6 col-md-4">
              <label class="form-label">Full Cost</label>
              <input type="number" class="form-control" id="rentFullCost" value="0" min="0">
            </div>
            <div class="col-12 col-md-4 mt-2 mt-md-0">
              <label class="form-label">Commission</label>
              <input type="number" class="form-control" id="rentCommission" value="0" min="0">
            </div>
          </div>
          <div class="mt-2">
            <label class="form-label">Status</label>
            <select class="form-select" id="rentStatus">
              <option>Booked</option>
              <option>Active</option>
              <option>Returned</option>
              <option>Cancelled</option>
            </select>
          </div>
          <div class="row g-2 mt-1">
            <div class="col-12 col-md-6">
              <label class="form-label">Renter Name (optional)</label>
              <input type="text" class="form-control" id="rentRenterName" placeholder="John Doe">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Contact No (optional)</label>
              <input type="text" class="form-control" id="rentContactNo" placeholder="+1 555 0100">
            </div>
          </div>
          <div class="mt-2">
            <small>Duration: <span id="addDuration" class="badge bg-light text-dark">0 days</span></small>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-success" id="submitAddRental">Add Rental</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Rental Modal -->
<div class="modal fade" id="editRentalModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Rental</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editRentalForm">
          <input type="hidden" id="editRentalId">
          <div class="row g-2">
            <div class="col-12 col-md-6">
              <label class="form-label">Start Date *</label>
              <input type="text" class="form-control" id="editRentStart" placeholder="DD/MM/YYYY" pattern="\d{1,2}/\d{1,2}/\d{4}" title="Please enter date in DD/MM/YYYY format" required>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">End Date *</label>
              <input type="text" class="form-control" id="editRentEnd" placeholder="DD/MM/YYYY" pattern="\d{1,2}/\d{1,2}/\d{4}" title="Please enter date in DD/MM/YYYY format" required>
            </div>
          </div>
          <div class="row g-2 mt-1">
            <div class="col-6 col-md-4">
              <label class="form-label">Advance</label>
              <input type="number" class="form-control" id="editRentAdvance" value="0" min="0">
            </div>
            <div class="col-6 col-md-4">
              <label class="form-label">Full Cost</label>
              <input type="number" class="form-control" id="editRentFullCost" value="0" min="0">
            </div>
            <div class="col-12 col-md-4 mt-2 mt-md-0">
              <label class="form-label">Commission</label>
              <input type="number" class="form-control" id="editRentCommission" value="0" min="0">
            </div>
          </div>
          <div class="mt-2">
            <label class="form-label">Status</label>
            <select class="form-select" id="editRentStatus">
              <option>Booked</option>
              <option>Active</option>
              <option>Returned</option>
              <option>Cancelled</option>
            </select>
          </div>
          <div class="row g-2 mt-1">
            <div class="col-12 col-md-6">
              <label class="form-label">Renter Name (optional)</label>
              <input type="text" class="form-control" id="editRenterName" placeholder="John Doe">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Contact No (optional)</label>
              <input type="text" class="form-control" id="editContactNo" placeholder="+1 555 0100">
            </div>
          </div>
          <div class="mt-2">
            <small>Duration: <span id="editDuration" class="badge bg-light text-dark">0 days</span></small>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="submitEditRental">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_BASE = '';
  const bikeSelect = document.getElementById('bikeSelect');
  const bikeSearch = document.getElementById('bikeSearch');
  const searchBikeBtn = document.getElementById('searchBikeBtn');
  const selectedBikeInfo = document.getElementById('selectedBikeInfo');
  const addRentalBtn = document.getElementById('addRentalBtn');
  const rentalsTableBody = document.querySelector('#rentalsTable tbody');
  const summaryTotal = document.getElementById('summaryTotal');
  const summaryActive = document.getElementById('summaryActive');
  const summaryRevenue = document.getElementById('summaryRevenue');
  const summaryCommission = document.getElementById('summaryCommission');
  const summaryPlatformFee = document.getElementById('summaryPlatformFee');
  const summaryServiceCharge = document.getElementById('summaryServiceCharge');
  const summaryOtherFees = document.getElementById('summaryOtherFees');
  const availableBikesList = document.getElementById('availableBikesList');
  const availableBikesEmpty = document.getElementById('availableBikesEmpty');

  let currentBike = null;
  let allBikes = [];
  let allAvailableBikes = [];

  document.addEventListener('DOMContentLoaded', () => {
    loadBikes();
    loadAvailableBikes();
    document.getElementById('submitAddBike').addEventListener('click', onAddBike);
    document.getElementById('submitAddRental').addEventListener('click', onAddRental);
    document.getElementById('submitEditRental').addEventListener('click', onEditRental);
    bikeSelect.addEventListener('change', onBikeChange);
    searchBikeBtn.addEventListener('click', onSearchBikes);

    // Add event listeners to update duration on date change in Add Rental modal
    document.getElementById('rentStart').addEventListener('change', updateAddDuration);
    document.getElementById('rentEnd').addEventListener('change', updateAddDuration);

    // Add event listeners to update duration on date change in Edit Rental modal
    document.getElementById('editRentStart').addEventListener('change', updateEditDuration);
    document.getElementById('editRentEnd').addEventListener('change', updateEditDuration);

    // Load dashboard charts if we're on the dashboard page
    if (window.location.pathname === '/dashboard') {
      loadDashboardCharts();
    }
  });

  function showToast(message, type = 'info') {
    const toastContainer = document.querySelector('.toast-container');
    const toastId = 'toast-' + Date.now();
    
    const toastEl = document.createElement('div');
    toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
    toastEl.setAttribute('role', 'alert');
    toastEl.setAttribute('aria-live', 'assertive');
    toastEl.setAttribute('aria-atomic', 'true');
    toastEl.id = toastId;
    
    toastEl.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    `;
    
    toastContainer.appendChild(toastEl);
    
    const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
    toast.show();
    
    // Remove the toast from DOM after it's hidden
    toastEl.addEventListener('hidden.bs.toast', () => {
      toastEl.remove();
    });
  }

  function parseDate(dateStr) {
    if (!dateStr) return '';
    const parts = dateStr.split('/');
    if (parts.length !== 3) return '';
    const day = parts[0].padStart(2, '0');
    const month = parts[1].padStart(2, '0');
    const year = parts[2];
    return `${year}-${month}-${day}`;
  }

  function formatToDisplay(dateStr) {
    if (!dateStr) return '';
    const parts = dateStr.split('-');
    if (parts.length !== 3) return dateStr;
    const year = parts[0];
    const month = parts[1];
    const day = parts[2];
    return `${day}/${month}/${year}`;
  }

  function isValidDate(dateStr) {
    const d = new Date(dateStr);
    return d instanceof Date && !isNaN(d);
  }

  function updateAddDuration() {
    const startInput = document.getElementById('rentStart').value;
    const endInput = document.getElementById('rentEnd').value;
    const parsedStart = parseDate(startInput);
    const parsedEnd = parseDate(endInput);
    const durationSpan = document.getElementById('addDuration');
    if (!isValidDate(parsedStart) || !isValidDate(parsedEnd)) {
      durationSpan.textContent = 'Invalid dates';
      durationSpan.className = 'badge bg-danger text-white';
      return;
    }
    const days = calculateDays(parsedStart, parsedEnd);
    durationSpan.textContent = `${days} days`;
    durationSpan.className = `badge ${days > 0 ? 'bg-success' : 'bg-danger'} text-white`;
  }

  function updateEditDuration() {
    const startInput = document.getElementById('editRentStart').value;
    const endInput = document.getElementById('editRentEnd').value;
    const parsedStart = parseDate(startInput);
    const parsedEnd = parseDate(endInput);
    const durationSpan = document.getElementById('editDuration');
    if (!isValidDate(parsedStart) || !isValidDate(parsedEnd)) {
      durationSpan.textContent = 'Invalid dates';
      durationSpan.className = 'badge bg-danger text-white';
      return;
    }
    const days = calculateDays(parsedStart, parsedEnd);
    durationSpan.textContent = `${days} days`;
    durationSpan.className = `badge ${days > 0 ? 'bg-success' : 'bg-danger'} text-white`;
  }

  async function loadBikes() {
    try {
      const res = await fetch(`${API_BASE}/bikes`);
      const data = await res.json();
      allBikes = data.bikes || [];
      renderBikeOptions(allBikes);
    } catch (e) {
      showToast('Failed to load bikes', 'danger');
    }
  }

  function renderBikeOptions(bikes) {
    bikeSelect.innerHTML = '<option value="" disabled selected>Choose a bike...</option>';
    bikes.forEach(b => {
      const opt = document.createElement('option');
      opt.value = b.bike_number;
      opt.textContent = `${b.bike_number} - ${b.bike_name}`;
      opt.dataset.name = b.bike_name || '';
      bikeSelect.appendChild(opt);
    });
  }

  async function loadAvailableBikes() {
    try {
      const res = await fetch(`${API_BASE}/bikes/available`);
      if (!res.ok) throw new Error('Failed to load available bikes');
      const data = await res.json();
      allAvailableBikes = data.available_bikes || [];
      renderAvailableBikes(allAvailableBikes);
    } catch (e) {
      availableBikesEmpty.textContent = 'Failed to load available bikes';
    }
  }

  function renderAvailableBikes(list) {
    availableBikesList.innerHTML = '';
    if (!list.length) {
      availableBikesEmpty.textContent = 'No bikes available';
      return;
    }
    availableBikesEmpty.textContent = '';
    list.forEach(b => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';
      li.textContent = `${b.bike_number} - ${b.bike_name || ''}`.trim();
      // Quick-select button
      const btn = document.createElement('button');
      btn.className = 'btn btn-sm btn-outline-primary';
      btn.textContent = 'Select';
      btn.addEventListener('click', () => {
        bikeSelect.value = b.bike_number;
        bikeSelect.dispatchEvent(new Event('change'));
      });
      li.appendChild(btn);
      availableBikesList.appendChild(li);
    });
  }

  function onSearchBikes() {
    const searchTerm = bikeSearch.value.trim().toLowerCase();
    if (!searchTerm) {
      // If no search term, show all
      renderBikeOptions(allBikes);
      renderAvailableBikes(allAvailableBikes);
      return;
    }

    let filteredBikes = [];
    let filteredAvailable = [];

    // Special case: if search term is exactly 4 digits, check for last 4 digits of bike_number
    const isLastFourDigits = /^\d{4}$/.test(searchTerm);
    if (isLastFourDigits) {
      filteredBikes = allBikes.filter(bike => 
        bike.bike_number.slice(-4).toLowerCase() === searchTerm
      );
      filteredAvailable = allAvailableBikes.filter(bike => 
        bike.bike_number.slice(-4).toLowerCase() === searchTerm
      );

      // If exactly one bike matches, auto-select it and load rentals
      if (filteredBikes.length === 1) {
        const matchingBike = filteredBikes[0];
        bikeSelect.value = matchingBike.bike_number;
        onBikeChange(); // Trigger selection to load rentals
        showToast(`Auto-loaded rentals for bike ending in ${searchTerm}`, 'success');
        return; // Don't render filtered list since we're auto-selecting
      }
    }

    // General search (partial match on number or name)
    if (!isLastFourDigits || filteredBikes.length === 0) {
      filteredBikes = allBikes.filter(bike => 
        bike.bike_number.toLowerCase().includes(searchTerm) ||
        (bike.bike_name && bike.bike_name.toLowerCase().includes(searchTerm))
      );
      filteredAvailable = allAvailableBikes.filter(bike => 
        bike.bike_number.toLowerCase().includes(searchTerm) ||
        (bike.bike_name && bike.bike_name.toLowerCase().includes(searchTerm))
      );
    }

    renderBikeOptions(filteredBikes);
    renderAvailableBikes(filteredAvailable);

    if (filteredBikes.length === 0) {
      showToast('No bikes found matching your search', 'warning');
    } else if (isLastFourDigits && filteredBikes.length > 1) {
      showToast(`${filteredBikes.length} bikes found ending in ${searchTerm}. Please select one.`, 'info');
    }
  }

  async function onBikeChange() {
    const number = bikeSelect.value;
    if (!number) {
      // No bike selected
      document.getElementById('bikeIndividualSummary').classList.add('d-none');
      selectedBikeInfo.textContent = `Selected: ${number} ${name ? '(' + name + ')' : ''}`;
      selectedBikeInfo.className = 'small p-2 bg-light rounded';
      addRentalBtn.disabled = true;
      rentalsTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">Select a bike to view rentals</td></tr>';
      return;
    }

    const name = bikeSelect.options[bikeSelect.selectedIndex].dataset.name || '';
    currentBike = { bike_number: number, bike_name: name };
    selectedBikeInfo.textContent = `Selected: ${number} ${name ? '(' + name + ')' : ''}`;
    selectedBikeInfo.className = 'small p-2 bg-light rounded';
    addRentalBtn.disabled = false;

    // Load rentals
    await loadRentals(number);

    // Load and render summary
    await loadBikeSummary(number);
  }

  async function loadBikeSummary(bikeNumber) {
    try {
      const res = await fetch(`${API_BASE}/bikes/${bikeNumber}/summary`);
      if (!res.ok) throw new Error('Failed to load bike summary');
      const data = await res.json();

      // Populate summary elements
      document.getElementById('bikeTotalRentals').textContent = data.total_rentals;
      document.getElementById('bikeTotalRevenue').textContent = `₹${data.total_revenue.toFixed(2)}`;
      document.getElementById('bikeTotalAdvance').textContent = `₹${data.total_advance.toFixed(2)}`;
      document.getElementById('bikeNetProfit').textContent = `₹${data.net_profit.toFixed(2)}`;
      document.getElementById('bikePurchasePrice').textContent = `₹${data.purchase_price.toFixed(2)}`;
      document.getElementById('bikeTotalExpenses').textContent = `₹${data.total_expenses.toFixed(2)}`;

      // Status counts
      document.getElementById('bikeStatusActive').textContent = data.status_counts.Active || 0;
      document.getElementById('bikeStatusBooked').textContent = data.status_counts.Booked || 0;
      document.getElementById('bikeStatusReturned').textContent = data.status_counts.Returned || 0;
      document.getElementById('bikeStatusCancelled').textContent = data.status_counts.Cancelled || 0;

      // Show summary
      document.getElementById('bikeIndividualSummary').classList.remove('d-none');
    } catch (e) {
      console.error('Error loading bike summary:', e);
      showToast('Failed to load bike summary', 'warning');
      document.getElementById('bikeIndividualSummary').classList.add('d-none');
    }
  }

  // Download bike report
  document.addEventListener('DOMContentLoaded', () => {
    // ... existing code ...
    document.getElementById('downloadBikeReportBtn').addEventListener('click', downloadBikeReport);
  });

  async function downloadBikeReport() {
    if (!currentBike) {
      showToast('Please select a bike first', 'warning');
      return;
    }

    try {
      showToast('Generating Excel report...', 'info');
      const res = await fetch(`${API_BASE}/bikes/${currentBike.bike_number}/report/download`);
      if (!res.ok) throw new Error('Failed to generate report');

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `bike_summary_${currentBike.bike_number}.xlsx`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('Bike report downloaded successfully!', 'success');
    } catch (e) {
      console.error('Error downloading bike report:', e);
      showToast('Failed to download bike report', 'danger');
    }
  }

  async function loadRentals(bikeNumber) {
    rentalsTableBody.innerHTML = '<tr><td colspan="8" class="text-muted text-center py-4">Loading rentals...</td></tr>';
    try {
      const res = await fetch(`${API_BASE}/bikes/${bikeNumber}/rentals`);
      if (!res.ok) throw new Error('Load rentals failed');
      const data = await res.json();
      renderRentals(data.rentals || []);
    } catch (e) {
      rentalsTableBody.innerHTML = '<tr><td colspan="8" class="text-danger text-center py-4">Failed to load rentals</td></tr>';
    }
  }

  function renderRentals(rentals) {
    if (!rentals.length) {
      rentalsTableBody.innerHTML = '<tr><td colspan="8" class="text-muted text-center py-4">No rentals yet</td></tr>';
      updateSummary([]);
      return;
    }
    
    rentalsTableBody.innerHTML = '';
    rentals.forEach(r => {
      const days = calculateDays(r.rent_start_date, r.rent_end_date);
      const tr = document.createElement('tr');
      
      // For mobile view, we'll add data-label attributes
      tr.innerHTML = `
        <td data-label="Period">${formatDate(r.rent_start_date)} - ${formatDate(r.rent_end_date)}<br><small>(${days} days)</small></td>
        <td data-label="Renter">${(r.renter_name || '-').toString()}</td>
        <td data-label="Contact">${(r.contact_no || '-').toString()}</td>
        <td data-label="Advance">₹${fmtNum(r.advance)}</td>
        <td data-label="Full Cost">₹${fmtNum(r.full_cost)}</td>
        <td data-label="Commission">₹${fmtNum(r.commission || 0)}</td>
        <td data-label="Status">
          <select class="form-select form-select-sm status-select" data-id="${r.rental_id}">
            <option value="Booked" ${r.status === 'Booked' ? 'selected' : ''}>Booked</option>
            <option value="Active" ${r.status === 'Active' ? 'selected' : ''}>Active</option>
            <option value="Returned" ${r.status === 'Returned' ? 'selected' : ''}>Returned</option>
            <option value="Cancelled" ${r.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
          </select>
        </td>
        <td class="text-end actions-cell">
          <button class="btn btn-sm btn-outline-primary me-1" data-action="edit" data-id="${r.rental_id}"><i class="fa fa-edit"></i></button>
          <button class="btn btn-sm btn-outline-danger" data-action="delete" data-id="${r.rental_id}"><i class="fa fa-trash"></i></button>
        </td>`;
      rentalsTableBody.appendChild(tr);
    });
    
    rentalsTableBody.querySelectorAll('button').forEach(btn => btn.addEventListener('click', onRentalAction));
    rentalsTableBody.querySelectorAll('.status-select').forEach(sel => sel.addEventListener('change', onStatusChange));
    updateSummary(rentals);
  }

  function updateSummary(rentals) {
    summaryTotal.textContent = rentals.length;
    summaryActive.textContent = rentals.filter(r => r.status === 'Active').length;
    const revenue = rentals.reduce((s, r) => s + (parseFloat(r.full_cost) || 0), 0);
    summaryRevenue.textContent = `₹${revenue.toFixed(2)}`;

    // Calculate commission breakdown
    let totalCommission = 0;
    let platformFee = 0;
    let serviceCharge = 0;
    let otherFees = 0;

    rentals.forEach(r => {
      const commissionData = r.commission;
      if (commissionData && typeof commissionData === 'object') {
        // New structure with separated commission
        platformFee += commissionData.platform_fee || 0;
        serviceCharge += commissionData.service_charge || 0;
        otherFees += commissionData.other_fees || 0;
        totalCommission += commissionData.total_commission || 0;
      } else {
        // Old structure with single commission value
        const singleCommission = parseFloat(r.commission) || 0;
        platformFee += singleCommission * 0.6;
        serviceCharge += singleCommission * 0.3;
        otherFees += singleCommission * 0.1;
        totalCommission += singleCommission;
      }
    });

    summaryCommission.textContent = `₹${totalCommission.toFixed(2)}`;
    summaryPlatformFee.textContent = `₹${platformFee.toFixed(2)}`;
    summaryServiceCharge.textContent = `₹${serviceCharge.toFixed(2)}`;
    summaryOtherFees.textContent = `₹${otherFees.toFixed(2)}`;
  }

  async function onAddBike() {
    const bike_number = document.getElementById('newBikeNumber').value.trim();
    const bike_name = document.getElementById('newBikeName').value.trim();
    if (!bike_number || !bike_name) { 
      showToast('Both fields are required', 'warning');
      return; 
    }
    
    try {
      const res = await fetch(`${API_BASE}/bikes`, { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/json' }, 
        body: JSON.stringify({ bike_number, bike_name }) 
      });
      
      if (!res.ok) { 
        const e = await res.json(); 
        throw new Error(e.error || 'Add bike failed'); 
      }
      
      document.getElementById('addBikeForm').reset();
      bootstrap.Modal.getInstance(document.getElementById('addBikeModal')).hide();
      showToast('Bike added successfully', 'success');
      await loadBikes();
      await loadAvailableBikes();

      // Auto-select the newly added bike
      bikeSelect.value = bike_number;
      bikeSelect.dispatchEvent(new Event('change'));
    } catch (e) { 
      showToast(e.message, 'danger');
    }
  }

  async function onAddRental() {
    if (!currentBike) return;
    
    const startInput = document.getElementById('rentStart').value.trim();
    const endInput = document.getElementById('rentEnd').value.trim();
    const parsedStart = parseDate(startInput);
    const parsedEnd = parseDate(endInput);
    
    if (!startInput || !endInput) { 
      showToast('Dates are required', 'warning');
      return; 
    }
    
    if (!isValidDate(parsedStart) || !isValidDate(parsedEnd)) {
      showToast('Please enter valid dates in DD/MM/YYYY format', 'warning');
      return;
    }
    
    const payload = {
      rent_start_date: parsedStart,
      rent_end_date: parsedEnd,
      advance: document.getElementById('rentAdvance').value || 0,
      full_cost: document.getElementById('rentFullCost').value || 0,
      commission: document.getElementById('rentCommission').value || 0,
      status: document.getElementById('rentStatus').value,
      bike_name: currentBike.bike_name || '',
      renter_name: document.getElementById('rentRenterName').value || '',
      contact_no: document.getElementById('rentContactNo').value || ''
    };
    
    try {
      const res = await fetch(`${API_BASE}/bikes/${currentBike.bike_number}/rentals`, { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/json' }, 
        body: JSON.stringify(payload) 
      });
      
      if (!res.ok) { 
        const e = await res.json(); 
        throw new Error(e.error || 'Add rental failed'); 
      }
      
      document.getElementById('addRentalForm').reset();
      bootstrap.Modal.getInstance(document.getElementById('addRentalModal')).hide();
      showToast('Rental added successfully', 'success');
      await loadRentals(currentBike.bike_number);
      await loadAvailableBikes();
    } catch (e) { 
      showToast(e.message, 'danger');
    }
  }

  function onRentalAction(ev) {
    const btn = ev.currentTarget;
    const action = btn.dataset.action;
    const rentalId = btn.dataset.id;
    if (action === 'delete') return deleteRental(rentalId);
    if (action === 'edit') return openEditRental(rentalId);
  }

  async function openEditRental(rentalId) {
    try {
      const res = await fetch(`${API_BASE}/bikes/${currentBike.bike_number}/rentals/${rentalId}`);
      if (!res.ok) throw new Error('Load rental failed');
      const r = await res.json();
      
      document.getElementById('editRentalId').value = r.rental_id;
      document.getElementById('editRentStart').value = formatToDisplay(r.rent_start_date || '');
      document.getElementById('editRentEnd').value = formatToDisplay(r.rent_end_date || '');
      document.getElementById('editRentAdvance').value = r.advance || 0;
      document.getElementById('editRentFullCost').value = r.full_cost || 0;
      document.getElementById('editRentCommission').value = r.commission || 0;
      document.getElementById('editRentStatus').value = r.status || 'Booked';
      document.getElementById('editRenterName').value = r.renter_name || '';
      document.getElementById('editContactNo').value = r.contact_no || '';
      
      updateEditDuration(); // Update duration display
      new bootstrap.Modal(document.getElementById('editRentalModal')).show();
    } catch (e) { 
      showToast(e.message, 'danger');
    }
  }

  async function onEditRental() {
    const rentalId = document.getElementById('editRentalId').value;
    const startInput = document.getElementById('editRentStart').value.trim();
    const endInput = document.getElementById('editRentEnd').value.trim();
    const parsedStart = parseDate(startInput);
    const parsedEnd = parseDate(endInput);
    
    if (!startInput || !endInput) { 
      showToast('Dates are required', 'warning');
      return; 
    }
    
    if (!isValidDate(parsedStart) || !isValidDate(parsedEnd)) {
      showToast('Please enter valid dates in DD/MM/YYYY format', 'warning');
      return;
    }
    
    const payload = {
      rent_start_date: parsedStart,
      rent_end_date: parsedEnd,
      advance: document.getElementById('editRentAdvance').value || 0,
      full_cost: document.getElementById('editRentFullCost').value || 0,
      commission: document.getElementById('editRentCommission').value || 0,
      status: document.getElementById('editRentStatus').value,
      renter_name: document.getElementById('editRenterName').value || '',
      contact_no: document.getElementById('editContactNo').value || ''
    };
    
    try {
      const res = await fetch(`${API_BASE}/bikes/${currentBike.bike_number}/rentals/${rentalId}`, { 
        method: 'PUT', 
        headers: { 'Content-Type': 'application/json' }, 
        body: JSON.stringify(payload) 
      });
      
      if (!res.ok) throw new Error('Update rental failed');
      
      bootstrap.Modal.getInstance(document.getElementById('editRentalModal')).hide();
      showToast('Rental updated successfully', 'success');
      await loadRentals(currentBike.bike_number);
      await loadAvailableBikes();
    } catch (e) { 
      showToast(e.message, 'danger');
    }
  }

  async function deleteRental(rentalId) {
    if (!confirm('Are you sure you want to delete this rental?')) return;
    
    try {
      const res = await fetch(`${API_BASE}/bikes/${currentBike.bike_number}/rentals/${rentalId}`, { method: 'DELETE' });
      if (!res.ok) throw new Error('Delete failed');
      
      showToast('Rental deleted successfully', 'success');
      await loadRentals(currentBike.bike_number);
      await loadAvailableBikes();
    } catch (e) { 
      showToast(e.message, 'danger');
    }
  }

  function formatDate(s) { 
    if (!s) return 'N/A'; 
    const d = new Date(s);
    const dd = String(d.getDate()).padStart(2, '0');
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const yyyy = d.getFullYear();
    return `${dd}/${mm}/${yyyy}`; 
  }
  
  function fmtNum(n) { 
    const v = parseFloat(n)||0; 
    return v.toFixed(2); 
  }
  
  function calculateDays(startDate, endDate) {
    if (!startDate || !endDate) return 0;
    const start = new Date(startDate);
    const end = new Date(endDate);
    const diffTime = Math.abs(end - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays;
  }

  async function onStatusChange(event) {
    const select = event.target;
    const rentalId = select.dataset.id;
    const newStatus = select.value;

    if (!currentBike || !rentalId) return;

    try {
      const res = await fetch(`${API_BASE}/bikes/${currentBike.bike_number}/rentals/${rentalId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
      });

      if (!res.ok) throw new Error('Failed to update status');

      showToast('Status updated successfully', 'success');
      await loadRentals(currentBike.bike_number);
    } catch (e) {
      showToast(e.message, 'danger');
      // Revert select to previous value on error
      await loadRentals(currentBike.bike_number);
    }
  }

  async function downloadReport() {
    try {
      showToast('Generating Excel report...', 'info');

      // Create a temporary link to trigger download
      const link = document.createElement('a');
      link.href = `${API_BASE}/report/download`;
      link.download = 'bike_report.xlsx';
      link.style.display = 'none';

      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showToast('Excel report downloaded successfully!', 'success');
    } catch (error) {
      console.error('Error downloading report:', error);
      showToast('Failed to download Excel report', 'danger');
    }
  }

  // Dashboard Charts Functions
  async function loadDashboardCharts() {
    try {
      // Show dashboard charts section
      document.getElementById('dashboardCharts').style.display = 'block';

      // Load graph data
      const res = await fetch(`${API_BASE}/dashboard/graph-data`);
      if (!res.ok) throw new Error('Failed to load dashboard data');
      const data = await res.json();

      // Render charts
      renderRevenueChart(data.revenue_trends);
      renderStatusChart(data.rental_status);
      renderExpenseChart(data.expense_breakdown);
      renderCommissionChart(data.commission_breakdown);

    } catch (error) {
      console.error('Error loading dashboard charts:', error);
      showToast('Failed to load dashboard charts', 'danger');
    }
  }

  function renderRevenueChart(revenueTrends) {
    const ctx = document.getElementById('revenueChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: revenueTrends.map(item => item.month),
        datasets: [
          {
            label: 'Rentals',
            data: revenueTrends.map(item => item.rentals),
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
          },
          {
            label: 'Expenses',
            data: revenueTrends.map(item => item.expenses),
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            tension: 0.1
          },
          {
            label: 'Profit',
            data: revenueTrends.map(item => item.profit),
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            tension: 0.1
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Revenue Trends (Last 6 Months)'
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  function renderStatusChart(statusCounts) {
    const ctx = document.getElementById('statusChart').getContext('2d');
    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: Object.keys(statusCounts),
        datasets: [{
          data: Object.values(statusCounts),
          backgroundColor: [
            'rgba(255, 205, 86, 0.8)',
            'rgba(54, 162, 235, 0.8)',
            'rgba(75, 192, 192, 0.8)',
            'rgba(255, 99, 132, 0.8)'
          ],
          borderColor: [
            'rgb(255, 205, 86)',
            'rgb(54, 162, 235)',
            'rgb(75, 192, 192)',
            'rgb(255, 99, 132)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Rental Status Distribution'
          }
        }
      }
    });
  }

  function renderExpenseChart(expenseBreakdown) {
    const ctx = document.getElementById('expenseChart').getContext('2d');
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: expenseBreakdown.map(item => `${item.bike_number} - ${item.bike_name}`),
        datasets: [{
          data: expenseBreakdown.map(item => item.expenses),
          backgroundColor: [
            'rgba(255, 99, 132, 0.8)',
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 205, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)',
            'rgba(153, 102, 255, 0.8)',
            'rgba(255, 159, 64, 0.8)'
          ],
          borderColor: [
            'rgb(255, 99, 132)',
            'rgb(54, 162, 235)',
            'rgb(255, 205, 86)',
            'rgb(75, 192, 192)',
            'rgb(153, 102, 255)',
            'rgb(255, 159, 64)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Expense Breakdown by Bike'
          }
        }
      }
    });
  }

  function renderCommissionChart(commissionBreakdown) {
    const ctx = document.getElementById('commissionChart').getContext('2d');
    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: Object.keys(commissionBreakdown),
        datasets: [{
          data: Object.values(commissionBreakdown),
          backgroundColor: [
            'rgba(75, 192, 192, 0.8)',
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 205, 86, 0.8)'
          ],
          borderColor: [
            'rgb(75, 192, 192)',
            'rgb(54, 162, 235)',
            'rgb(255, 205, 86)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Commission Breakdown by Type'
          }
        }
      }
    });
  }
</script>
</body>
</html>
